import streamlit as st
from langchain.chat_models import ChatOpenAI
from langchain.schema import (SystemMessage, HumanMessage, AIMessage)
import openai
from langchain.callbacks import get_openai_callback
from langchain.prompts import PromptTemplate
from langchain.chains.summarize import load_summarize_chain
from langchain.chains.combine_documents.base import Document
import os
from langchain.schema import (
    SystemMessage,
    HumanMessage,
    AIMessage
)

# OpenAI APIã‚­ãƒ¼ã‚’è¨­å®š
os.environ["OPENAI_API_KEY"] = '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'
def main():
    llm = ChatOpenAI(temperature=0)


def init_page():
    st.set_page_config(
        page_title="æ„›åª›æ–°èè¦ç´„ã‚¢ãƒ—ãƒª",
        page_icon="ğŸ¤—"
        page_title="è¦ç´„ã‚¢ãƒ—ãƒª",
        page_icon="ğŸ§ "
    )
    st.header("æ„›åª›æ–°èè¦ç´„ã‚¢ãƒ—ãƒª ğŸ¤—")
    st.header("è¦ç´„ã‚¢ãƒ—ãƒª ğŸ§ ")

    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
    st.sidebar.title("ãƒ¢ãƒ‡ãƒ«é¸æŠ")
    st.session_state.costs = []

    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®åˆæœŸåŒ–
    if "messages" not in st.session_state:
def init_messages():
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒœã‚¿ãƒ³ã‚’è¨­ç½®
    clear_button = st.sidebar.button("å±¥æ­´å‰Šé™¤", key="clear")
    if clear_button or "messages" not in st.session_state:
        st.session_state.messages = [
            SystemMessage(content="å…¥åŠ›ã•ã‚ŒãŸæ–‡ç« ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚")
            SystemMessage(content="ãƒ‡ãƒ¢æ®µéšã§ã‚ã‚‹ãŸã‚ã€ãŸã chatgptã®apiã‚’ä½¿ç”¨ã—ã¦webappã‚’ä½œæˆã—ãŸã ã‘ã«ãªã£ã¦ã„ã‚‹ãŒä»Šå¾Œè¦ç´„ã‚¢ãƒ—ãƒªã¨ã—ã¦å·¥å¤«ã—ã¦ã„ã")
        ]
        st.session_state.costs = []

def select_model():
    model = st.sidebar.radio("Choose a model:", ("GPT-3.5", "GPT-4"))
    if model == "GPT-3.5":
        model_name = "gpt-3.5-turbo"
    else:
        model_name = "gpt-4"

    return ChatOpenAI(temperature=0, model_name=model_name)

def get_text_input():
    text_input = st.text_area("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="input", height=200)
    return text_input

def summarize(llm, docs):
    prompt_template = """
#å‘½ä»¤æ›¸
è¦‹å‡ºã—:
å¥³æ€§ç¾ã€€è¡¨ç¾ã®å¤‰é·ã€€æ–°å±…æµœå¸‚ç¾è¡“é¤¨ã€Œæã‹ã‚ŒãŸå¥³ãŸã¡ã€ã€€æ˜æ²»ã‹ã‚‰ç¾ä»£ã€€æ—¥æœ¬ã®æ´‹ç”»ï¼˜ï¼‘ç‚¹ã€€æ¥æœˆï¼’ï¼–æ—¥ã¾ã§
æœ¬æ–‡:
ã€€è¥¿æ´‹ç¾è¡“ã¨ã®å‡ºåˆã„ã¯ã€æ—¥æœ¬äººç”»å®¶ãŒæãäººä½“åƒã«ã©ã‚“ãªå¤‰åŒ–ã‚’ã‚‚ãŸã‚‰ã—ãŸã®ã‹â€•ã€‚å¥³æ€§ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸæ˜æ²»æ™‚ä»£ã‹ã‚‰ç¾ä»£ã®æ´‹ç”»ã‚’é€šã˜ãã®å¤‰é·ã«è¿«ã‚‹ç‰¹åˆ¥å±•ã€Œæã‹ã‚ŒãŸå¥³ãŸã¡â€•å¥³æ€§åƒã«ã¿ã‚‹ãƒ•ã‚©ãƒ«ãƒ ï¼ç¾å®Ÿï¼å¤¢ã€ãŒã€æ–°å±…æµœå¸‚å‚äº•ç”ºï¼’ä¸ç›®ã®å¸‚ç¾è¡“é¤¨ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ã€‚æ—¥å‹•ç¾è¡“è²¡å›£æ‰€è”µã®ï¼—ï¼•ç‚¹ã‚’ä¸­å¿ƒã«è¨ˆï¼˜ï¼‘ç‚¹ãŒä¸¦ã¶ã€‚ï¼–æœˆï¼’ï¼–æ—¥ã¾ã§ã€‚
ã€€æ˜æ²»æœŸã«è¥¿æ´‹ç¾è¡“ã«æ¥ã—ãŸæ—¥æœ¬ç”»å£‡ã¯ã€å¯¾è±¡ã®ç§‘å­¦çš„ãªæ‰ãˆæ–¹ã‚„é™°å½±æ³•ãªã©ã®æŠ€æ³•ã ã‘ã§ãªãã€çµµç”»ã¨ã¯ä½•ã‹ã¨ã„ã£ãŸæ¦‚å¿µã‚‚å¸åã—ãŸã€‚ç‰¹åˆ¥å±•ã§ã¯æ±éƒ·é’å…ã€ç«¹ä¹…å¤¢äºŒã€ç™¾æ­¦å…¼è¡Œã€çµ¹è°·å¹¸äºŒã€å²¸ç”°åŠ‰ç”Ÿã€è—¤å³¶æ­¦äºŒã‚‰ãŒæã„ãŸã€Œå¥³æ€§ç¾ã€ã‹ã‚‰ã€è¡¨ç¾ã®å¤šæ§˜æ€§ã‚’æµ®ã‹ã³ä¸ŠãŒã‚‰ã›ã¦ã„ã‚‹ã€‚å±•ç¤ºä½œå“ã®ä¸€éƒ¨ã‚’ç´¹ä»‹ã™ã‚‹ã€‚ï¼ˆæ‰€è”µã¯å…¨ã¦æ—¥å‹•ç¾è¡“è²¡å›£ï¼‰
- å¯ºå³¶ãŒä½œæˆã—ãŸè¦ç´„æ–‡ç« 
å¥³æ€§ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸæ˜æ²»æ™‚ä»£ã‹ã‚‰ç¾ä»£ã®æ´‹ç”»ã‚’é€šã˜ãã®å¤‰é·ã«è¿«ã‚‹ç‰¹åˆ¥å±•ã€Œæã‹ã‚ŒãŸå¥³ãŸã¡â€•å¥³æ€§åƒã«ã¿ã‚‹ãƒ•ã‚©ãƒ«ãƒ ï¼ç¾å®Ÿï¼å¤¢ã€ãŒã€æ–°å±…æµœå¸‚å‚äº•ç”ºï¼’ä¸ç›®ã®å¸‚ç¾è¡“é¤¨ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ã€‚æ—¥å‹•ç¾è¡“è²¡å›£æ‰€è”µã®ï¼—ï¼•ç‚¹ã‚’ä¸­å¿ƒã«è¨ˆï¼˜ï¼‘ç‚¹ãŒä¸¦ã³ã€å±•ç¤ºæœŸé–“ã¯6æœˆ26æ—¥ã¾ã§ã§ã‚ã‚‹ã€‚
è¦‹å‡ºã—:
å¤§ç‹è£½ç´™ã€€ãŠã‚€ã¤åŸæ–™ã€€è‡ªç¤¾ç”Ÿç”£ã€€æˆ¦ç•¥èª¬æ˜ä¼šã€€è¼¸å…¥ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆ
æœ¬æ–‡:
ã€€å¤§ç‹è£½ç´™ï¼ˆå››å›½ä¸­å¤®å¸‚ã€è‹¥æ—è³´æˆ¿ç¤¾é•·ï¼‰ã¯ï¼’ï¼–æ—¥ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§æˆ¦ç•¥èª¬æ˜ä¼šã‚’é–‹ãã€ï¼’ï¼ï¼’ï¼‘ï½ï¼’ï¼“å¹´åº¦ã®ç¬¬ï¼”æ¬¡ä¸­æœŸäº‹æ¥­è¨ˆç”»ã®é€²å±•ã‚„ä»Šå¾Œã®æ–¹å‘æ€§ã‚’æ˜ã‚‰ã‹ã«ã—ãŸã€‚å®¶åº­ç´™ãªã©ã®ãƒ›ãƒ¼ãƒ ï¼†ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚±ã‚¢ï¼ˆï¼¨ï¼†ï¼°ï¼£ï¼‰äº‹æ¥­æ¨é€²ã‚„ä¸»åŠ›ã®ä¸‰å³¶å·¥å ´ï¼ˆå››å›½ä¸­å¤®å¸‚ï¼‰ã€å²é˜œçœŒã®æ–°å·¥å ´ãªã©ã‚’è»¸ã«æ§‹é€ æ”¹é©ã‚’é€²ã‚ã‚‹ã¨ã—ã¦ã„ã‚‹ã€‚ 
ï¼¨ï¼†ï¼°ï¼£äº‹æ¥­ã§ã¯ã€ç´™ãŠã‚€ã¤ãªã©ã®å¸åä½“è£½å“ã«ä½¿ã†ãƒ•ãƒ©ãƒƒãƒ•ï¼ˆç¶¿çŠ¶ï¼‰ãƒ‘ãƒ«ãƒ—ã‚’åŒ—ç±³ã‹ã‚‰ã®è¼¸å…¥ã«é ¼ã£ã¦ããŸãŒã€äºˆå®šã‚’å‰å€’ã—ã—ï¼’ï¼“å¹´ï¼—æœˆã‹ã‚‰ä¸‰å³¶å·¥å ´ã§ç”Ÿç”£ã‚’å§‹ã‚ã‚‹äºˆå®šã€‚è‹¥æ—ç¤¾é•·ã¯ã€Œãƒ•ãƒ©ãƒƒãƒ•ãƒ‘ãƒ«ãƒ—ã®ä¾¡æ ¼ã¯ä»Šå¾Œã‚‚é«˜æ­¢ã¾ã‚Šã™ã‚‹ã¨ã¿ã¦ã„ã‚‹ã€ã¨ã—ã€ä¸€éƒ¨ã‚’è‡ªç¤¾ã§è£½é€ ã—ã‚³ã‚¹ãƒˆã‚’ä¸‹ã’ã‚‹ã€‚
ä¸‰è±è‡ªå‹•è»Šã®å­ä¼šç¤¾ãƒ»ãƒ‘ã‚¸ã‚§ãƒ­è£½é€ ï¼ˆå²é˜œçœŒå‚ç¥ç”ºï¼‰ã‹ã‚‰ï¼’ï¼“å¹´ï¼‘æœˆã«è³¼å…¥ã™ã‚‹æ–°å·¥å ´äºˆå®šåœ°ã¯ï¼”æœˆã«ç‰©æµæ‹ ç‚¹ã¨ã—ã¦ç¨¼åƒã•ã›ã€ï¼’ï¼”å¹´ï¼‘ï¼æœˆã‹ã‚‰ã¯ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒšãƒ¼ãƒ‘ãƒ¼ã‚„ãƒˆã‚¤ãƒ¬ãƒƒãƒˆãƒšãƒ¼ãƒ‘ãƒ¼ã‚’ç”Ÿç”£ã™ã‚‹ã€‚è¿‘ãã®å¯å…å·¥å ´ï¼ˆåŒçœŒå¯å…å¸‚ï¼‰ã«ã‚‚å®¶åº­ç´™ç”¨æŠ„ç´™æ©Ÿã‚’å¢—è¨­ã—ã€ä¸¡å·¥å ´ã§æœˆç”£è¨ˆï¼“åƒãƒˆãƒ³ã‚’è¦‹è¾¼ã‚€ã€‚ä¸€é€£ã®è¨­å‚™æŠ•è³‡é¡ã¯ç´„ï¼‘ï¼—ï¼å„„å††ã€‚éœ€è¦ã®å¤šã„é¦–éƒ½åœã¸ã®é…é€ã‚’å¼·åŒ–ã™ã‚‹ã€‚ 
æµ·å¤–é–¢é€£ã§ã¯äº‹æ¥­ã®è¤‡åˆåŒ–ã‚’é€²ã‚ã‚‹ã€‚ä¸­å›½å¸‚å ´ã§ãƒ•ã‚§ãƒŸãƒ‹ãƒ³ã‚±ã‚¢å•†å“ã®ç¾åœ°ç”Ÿç”£
ã‚’å§‹ã‚ã¦ãŠã‚Šã€è¡›ç”Ÿç”¨ç´™ã®ãƒ©ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’æ‹¡å……ã€‚ãƒ™ãƒ“ãƒ¼ç”¨ç´™ãŠã‚€ã¤ä»¥å¤–ã®å£²ã‚Šä¸Šã’æ§‹æˆã‚’ï¼’ï¼‘å¹´ã®ï¼‘ï¼ï¼…ã‹ã‚‰ï¼’ï¼’å¹´ã¯ï¼’ï¼•ï¼…ã«å¢—ã‚„ã™ã€‚ 
ã‚³ã‚¹ãƒˆæ§‹é€ å¤‰åŒ–ã¸ã®å¯¾å¿œã¨å¾ªç’°å‹ç¤¾ä¼šã¸ã®å–ã‚Šçµ„ã¿ã¨ã—ã¦ã€æ¿ç´™ã¸ã®é›£å‡¦ç†å¤ç´™é…åˆç‡ã‚’ï¼“ï¼å¹´åº¦ã«ï¼“ï¼ï¼…ã¨ã™ã‚‹ç›®æ¨™ã‚’æ²ã’ãŸã€‚ä½¿ç”¨æ¸ˆã¿ç´™ãŠã‚€ã¤ã®ãƒªã‚µã‚¤ã‚¯ãƒ«æŠ€è¡“ã®ç¢ºç«‹ã«ã‚‚å–ã‚Šçµ„ã‚€ã€‚ 
ç¬¬ï¼”æ¬¡è¨ˆç”»æœ€çµ‚ã®ï¼’ï¼“å¹´åº¦é€£çµæ±ºç®—ã§å£²ä¸Šé«˜ï¼—ï¼’ï¼ï¼å„„å††ã€å–¶æ¥­åˆ©ç›Šï¼•ï¼‘ï¼å„„å††ã‚’ç›®æ¨™ã¨ã™ã‚‹ä¸€æ–¹ã€åŸç‡ƒæ–™ä¾¡æ ¼é«˜é¨°ãŒåç›Šã‚’åœ§è¿«ã—ã€é€£çµå–¶æ¥­åˆ©ç›Šã¯ï¼’ï¼‘å¹´åº¦ã®ï¼“ï¼—ï¼–å„„å††ã‹ã‚‰ï¼’ï¼’å¹´åº¦ã¯ï¼’ï¼•ï¼å„„å††ã«æ¸›ç›Šã¨ãªã‚‹è¦‹é€šã—ã‚’ç¤ºã—ãŸã€‚ï¼ˆè…äº®è¼”ï¼‰
- å¯ºå³¶ãŒä½œæˆã—ãŸè¦ç´„æ–‡ç« 
    
    å¤§ç‹è£½ç´™ã¯26æ—¥ã€ï¼’ï¼ï¼’ï¼‘ï½ï¼’ï¼“å¹´åº¦ã®ç¬¬ï¼”æ¬¡ä¸­æœŸäº‹æ¥­è¨ˆç”»ã®é€²å±•ã‚„ä»Šå¾Œã®æ–¹å‘æ€§ã¨ã—ã¦ã€å®¶åº­ç´™ãªã©ã®ãƒ›ãƒ¼ãƒ ï¼†ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚±ã‚¢ï¼ˆï¼¨ï¼†ï¼°ï¼£ï¼‰äº‹æ¥­æ¨é€²ã‚„ä¸»åŠ›ã®ä¸‰å³¶å·¥å ´ï¼ˆå››å›½ä¸­å¤®å¸‚ï¼‰ã€å²é˜œçœŒã®æ–°å·¥å ´ãªã©ã‚’è»¸ã«æ§‹é€ æ”¹é©ã‚’é€²ã‚ã‚‹ã¨æ˜ã‚‰ã‹ã«ã—ãŸã€‚ï¼¨ï¼†ï¼°ï¼£äº‹æ¥­ã§ã¯ã€ç´™ãŠã‚€ã¤ãªã©ã®å¸åä½“è£½å“ã«ä½¿ã†ãƒ•ãƒ©ãƒƒãƒ•ï¼ˆç¶¿çŠ¶ï¼‰ãƒ‘ãƒ«ãƒ—ã‚’ï¼’ï¼“å¹´ï¼—æœˆã‹ã‚‰ä¸‰å³¶å·¥å ´ã§ç”Ÿç”£é–‹å§‹äºˆå®šã§ã‚ã‚‹ã€‚å²é˜œçœŒã®æ–°å·¥å ´ã¯ã€ï¼’ï¼“å¹´ï¼”æœˆã«ç‰©æµæ‹ ç‚¹ã¨ã—ã¦ç¨¼åƒã•ã›ã€ï¼’ï¼”å¹´ï¼‘ï¼æœˆã‹ã‚‰ã¯ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒšãƒ¼ãƒ‘ãƒ¼ã‚„ãƒˆã‚¤ãƒ¬ãƒƒãƒˆãƒšãƒ¼ãƒ‘ãƒ¼ã‚’ç”Ÿç”£ã™ã‚‹ã€‚æµ·å¤–é–¢é€£ã§ã¯äº‹æ¥­ã®è¤‡åˆåŒ–ã‚’é€²ã‚ã€è¡›ç”Ÿç”¨ç´™ã®ãƒ©ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’æ‹¡å……ã™ã‚‹ã€‚ã‚³ã‚¹ãƒˆæ§‹é€ å¤‰åŒ–ã¸ã®å¯¾å¿œã¨å¾ªç’°å‹ç¤¾ä¼šã¸ã®å–ã‚Šçµ„ã¿ã¨ã—ã¦ã€æ¿ç´™ã¸ã®é›£å‡¦ç†å¤ç´™é…åˆç‡ã‚’ï¼“ï¼å¹´åº¦ã«ï¼“ï¼ï¼…ã¨ã™ã‚‹ç›®æ¨™ã‚’æ²ã’ãŸã€‚ç¬¬ï¼”æ¬¡è¨ˆç”»æœ€çµ‚ã®ï¼’ï¼“å¹´åº¦é€£çµæ±ºç®—ã§å£²ä¸Šé«˜ï¼—ï¼’ï¼ï¼å„„å††ã€å–¶æ¥­åˆ©ç›Šï¼•ï¼‘ï¼å„„å††ã‚’ç›®æ¨™ã¨ã™ã‚‹ä¸€æ–¹ã€åŸç‡ƒæ–™ä¾¡æ ¼é«˜é¨°ãŒåç›Šã‚’åœ§è¿«ã—ã€é€£çµå–¶æ¥­åˆ©ç›Šã¯ï¼’ï¼‘å¹´åº¦ã®ï¼“ï¼—ï¼–å„„å††ã‹ã‚‰ï¼’ï¼’å¹´åº¦ã¯ï¼’ï¼•ï¼å„„å††ã«æ¸›ç›Šã¨ãªã‚‹è¦‹é€šã—ã‚’ç¤ºã—ãŸã€‚
ä»¥ä¸Šã®ã‚ˆã†ã«æœ¬æ–‡ã‚’å¯ºå³¶ã®ã‚ˆã†ã«è¦ç´„ã—ã¦ä¸‹ã•ã„ã€‚
#å…¥åŠ›ã™ã‚‹æ–‡ç« 
{text:}
#å‡ºåŠ›å½¢å¼
è¦ç´„ã—ãŸæ–‡ç« :
"""

    PROMPT = PromptTemplate(template=prompt_template, input_variables=["text"])

    with get_openai_callback() as cb:
        chain = load_summarize_chain( 
            llm,
            chain_type="stuff",
            verbose=True,
            prompt=PROMPT
        )

        # Create a Document with page_content set to content
        document = Document(
            page_content=docs[0]["content"],
            title=docs[0]["title"]
        )
        response = chain({"input_documents": [document]}, return_only_outputs=True)

    return response['output_text'], cb.total_cost

def main():
    init_page()
    llm = select_model()
    init_messages()

    container = st.container()
    response_container = st.container()

    with container:
        text_input = get_text_input()
        run_button = st.button("å®Ÿè¡Œ")

    if text_input and run_button:
        document = [{"content": text_input, "title": "User Input"}]

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ç›£è¦–
    if user_input := st.chat_input("è¦ç´„ã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ã­ï¼"):
        st.session_state.messages.append(HumanMessage(content=user_input))
        with st.spinner("ChatGPT is typing ..."):
            response = llm(st.session_state.messages)
        st.session_state.messages.append(AIMessage(content=response.content))

    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
    messages = st.session_state.get('messages', [])
    for message in messages:
        if isinstance(message, AIMessage):
            with st.chat_message('assistant'):
                st.markdown(message.content)
        elif isinstance(message, HumanMessage):
            with st.chat_message('user'):
                st.markdown(message.content)
        else:  # isinstance(message, SystemMessage):
            st.write(f"System message: {message.content}")
            output_text, cost = summarize(llm, document)
        st.session_state.costs.append(cost)
    else:
        output_text = None

    if output_text:
        with response_container:
            st.markdown("## Summary")
            st.write(output_text)
            st.markdown("---")
            st.markdown("## Original Text")
            st.write("User Input")

    costs = st.session_state.get('costs', [])
    st.sidebar.markdown("## Costs")
    st.sidebar.markdown(f"**Total cost: ${sum(costs):.5f}**")
    for cost in costs:
        st.sidebar.markdown(f"- ${cost:.5f}")

if __name__ == '__main__':
    main()
